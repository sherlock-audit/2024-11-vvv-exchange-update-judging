Fresh Fossilized Seahorse

High

# Incorrect Implementation of EIP-712 Domain Separator in VVVCInvestmentLedger.sol

### Summary

The implementation of the EIP-712 domain separator in VVVCInvestmentLedger.sol is incorrect. The DOMAIN_SEPARATOR is calculated using the DOMAIN_TYPEHASH, which expects a string for the domain name. However, the name field is passed as a bytes32 value (generated by keccak256), rather than the string type specified in the DOMAIN_TYPEHASH. This mismatch creates a non-compliant EIP-712 domain separator, potentially leading to issues in signature verification.



### Root Cause

The root cause of the issue is the incorrect handling of the name parameter in the domain separator. The DOMAIN_TYPEHASH explicitly expects a string type for the domain name, but the implementation in VVVCInvestmentLedger.sol incorrectly passes a bytes32 type (keccak256 hash of the name).

```solidity
bytes32 public constant DOMAIN_TYPEHASH = keccak256(bytes("EIP712Domain(string name,uint256 chainId,address verifyingContract)"));
```

[Code](https://github.com/sherlock-audit/2024-11-vvv-exchange-update/blob/main/vvv-platform-smart-contracts/contracts/vc/VVVVCInvestmentLedger.sol#L127-L134)

[Code](https://github.com/sherlock-audit/2024-11-vvv-exchange-update/blob/main/vvv-platform-smart-contracts/contracts/vc/VVVVCTokenDistributor.sol#L92-L99)

```solidity
DOMAIN_SEPARATOR = keccak256(
    abi.encode(
        DOMAIN_TYPEHASH,
        keccak256(abi.encodePacked("VVV", _environmentTag)), // keccak256 returns bytes32
        block.chainid,
        address(this)
    )
);
```

In EIP-712, the name parameter should remain a string, as defined in the type hash. Encoding it as bytes32 disrupts compatibility with other systems expecting a valid EIP-712-compliant domain separator.

### Internal pre-conditions

_No response_

### External pre-conditions

_No response_

### Attack Path

_No response_

### Impact

Failed Signature Verification: Since the `DOMAIN_SEPARATOR` is improperly constructed, signatures generated using an EIP-712-compliant domain separator will not match the separator stored in the contract. This can result in failed verifications and prevent users from executing `claim` and `invest` functions.

### PoC

_No response_

### Mitigation

To fix the issue, ensure that the name parameter in the domain separator is properly handled as a string, in accordance with EIP-712.