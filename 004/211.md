Silly Orchid Platypus

Medium

# Non-Compliance with EIP-712 Standard: Dynamic Array Encoding in `ClaimParams` Signature Validation

### Summary

The `_isSignatureValid` function fails EIP-712 standards by not hashing dynamic arrays in `ClaimParams`. This causes signatures generated by standard tools like ethers.js or Foundry to fail validation, making the `claim()` function unusable for compatible users. Updating to hash dynamic arrays fixes compatibility and ensures the contract meets EIP-712 rules.

### Root Cause



The `_isSignatureValid` function incorrectly encodes dynamic arrays (`address[] projectTokenProxyWallets` and `uint256[] tokenAmountsToClaim`) in the `ClaimParams` struct without hashing them using `keccak256`. This deviates from the EIP-712 standard, which requires dynamic arrays to be hashed before inclusion in the `abi.encode` call. Consequently, signatures generated by compliant tools do not match the contract's validation logic.

### Reference  
[Code Link for `isSignature` Function](https://github.com/sherlock-audit/2024-11-vvv-exchange-update/blob/1791f41b310489aaa66de349ef1b9e4bd331f14b/vvv-platform-smart-contracts/contracts/vc/VVVVCTokenDistributor.sol#L157) 


### Proof of Concept

## Vulnerable Code
In the `_isSignatureValid` function, the dynamic arrays are directly passed into `abi.encode` without first being hashed:  
```solidity
digest = keccak256(
    abi.encodePacked(
        "\x19\x01",
        DOMAIN_SEPARATOR,
        keccak256(
            abi.encode(
                CLAIM_TYPEHASH,
                _params.kycAddress,
                _params.projectTokenAddress,
                _params.projectTokenProxyWallets,  // Incorrect: Dynamic type not hashed
                _params.tokenAmountsToClaim,       // Incorrect: Dynamic type not hashed
                _params.nonce,
                _params.deadline
            )
        )
    )
);
```


### Internal pre-conditions

_No response_

### External pre-conditions

_No response_

### Attack Path

_No response_

### Impact

The `_isSignatureValid` function does not correctly encode dynamic array values (`address[] projectTokenProxyWallets` and `uint256[] tokenAmountsToClaim`) as per the EIP-712 standard. As a result, signatures generated using standard tools like ethers.js and Foundry will be incompatible with the validation logic in the contract. This renders token claim functionality unusable for users relying on compliant tools and libraries, effectively breaking the intended functionality of the contract.  


### PoC

_No response_

### Mitigation

Dynamic arrays should be hashed with `keccak256` before being passed to `abi.encode`